name: ci-cd-docker

on:
  push:
    branches: ["main"] # PR 머지 후 main으로 push되면 실행

permissions:
  contents: read
  packages: write

concurrency:
  group: ci-cd-${{ github.ref }}
  cancel-in-progress: true

env:
  REGISTRY: docker.io
  IMAGE_NAME: ${{ secrets.DOCKERHUB_REPO }}
  USE_FLOATING_LATEST: "false"
  PLATFORMS: "linux/amd64"                 # ← 기본 플랫폼 지정(필요 시 arm64 추가)

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    outputs:
      prod_tag: ${{ steps.ver.outputs.prod_tag }}
      sha_tag:  ${{ steps.ver.outputs.sha_tag }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Compute immutable tags
        id: ver
        shell: bash
        run: |
          DATE=$(date +%Y%m%d)
          SHORT_SHA=$(echo "${GITHUB_SHA}" | cut -c1-7)
          FULL_SHA="${GITHUB_SHA}"
          PROD_TAG="prod-${DATE}-${SHORT_SHA}"
          echo "prod_tag=${PROD_TAG}" >> "$GITHUB_OUTPUT"
          echo "sha_tag=sha-${FULL_SHA}" >> "$GITHUB_OUTPUT"
          echo "version_for_build=${PROD_TAG}" >> "$GITHUB_OUTPUT"

      - name: Build & Push (immutable tags)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: true
          platforms: ${{ env.PLATFORMS }}
          build-args: |
            APP_VERSION=${{ steps.ver.outputs.version_for_build }}
          tags: |
            ${{ env.IMAGE_NAME }}:${{ steps.ver.outputs.prod_tag }}
            ${{ env.IMAGE_NAME }}:${{ steps.ver.outputs.sha_tag }}
          labels: |
            org.opencontainers.image.source=${{ github.repository }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.created=${{ github.event.head_commit.timestamp }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Summary
        run: |
          echo "Pushed:"
          echo " - ${{ env.IMAGE_NAME }}:${{ steps.ver.outputs.prod_tag }}"
          echo " - ${{ env.IMAGE_NAME }}:${{ steps.ver.outputs.sha_tag }}"
          if [ "${{ env.USE_FLOATING_LATEST }}" = "true" ]; then
            echo " - ${{ env.IMAGE_NAME }}:prod-latest (floating, do NOT use for deploy)"
          fi

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest

    steps:
      - name: Write SSH key
        id: key
        shell: bash
        run: |
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > key.pem
          chmod 600 key.pem

      - name: Add host to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H "${{ secrets.SSH_HOST }}" >> ~/.ssh/known_hosts

      - name: Deploy over SSH
        shell: bash
        env:
          HOST: ${{ secrets.SSH_HOST }}
          USER: ${{ secrets.SSH_USER }}
          DEPLOY_TAG: ${{ needs.build-and-push.outputs.prod_tag }}
          IMAGE_REPO: ${{ env.IMAGE_NAME }}
          ENV_FILE: ${{ secrets.ENV_PATH }}
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
        run: |
          ssh -i key.pem -o StrictHostKeyChecking=yes "${USER}@${HOST}" \
            "IMAGE_REPO='${IMAGE_REPO}' DEPLOY_TAG='${DEPLOY_TAG}' ENV_FILE='${ENV_FILE}' DOCKERHUB_USERNAME='${DOCKERHUB_USERNAME}' DOCKERHUB_TOKEN='${DOCKERHUB_TOKEN}' bash -s" <<'EOSH'
          set -euo pipefail

          APP=backend
          IMAGE="${IMAGE_REPO}:${DEPLOY_TAG}"
          PORTS="-p 8080:8080"
          ENV_FILE_PATH="${ENV_FILE}"

          # 프라이빗 레포 로그인
          if [[ -n "${DOCKERHUB_USERNAME:-}" && -n "${DOCKERHUB_TOKEN:-}" ]]; then
            echo "${DOCKERHUB_TOKEN}" | docker login -u "${DOCKERHUB_USERNAME}" --password-stdin || true
          fi

          docker pull "${IMAGE}"

          docker stop "${APP}" 2>/dev/null || true
          docker rm   "${APP}" 2>/dev/null || true

          docker run -d --name "${APP}" \
            --restart unless-stopped \
            --env-file "${ENV_FILE_PATH}" \
            ${PORTS} \
            "${IMAGE}"

          docker image prune -f
          EOSH
